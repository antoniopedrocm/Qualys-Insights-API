<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qualys Security Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app-container">
    <!-- Barra Lateral de Navega√ß√£o -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h1>üõ°Ô∏è Q-Insights</h1>
        <span>by Antonio Pedro</span>
      </div>
      <ul class="nav-tabs">
        <li><button class="tab-btn active" onclick="showTab('dashboard')">üìä Dashboard Executivo</button></li>
        <li><button class="tab-btn" onclick="showTab('vulnerabilities')">üî¥ An√°lise de Vulnerabilidades</button></li>
        <li><button class="tab-btn" onclick="showTab('efetividade')">üìà Efetividade</button></li>
        <li><button class="tab-btn" onclick="showTab('hosts')">üíª Invent√°rio de Hosts</button></li>
        <li><button class="tab-btn" onclick="showTab('scans')">üîç Status dos Scans</button></li>
        <li><button class="tab-btn" onclick="showTab('api')">‚öôÔ∏è API Explorer</button></li>
      </ul>
    </nav>

    <!-- Conte√∫do Principal -->
    <main class="main-content">
      <header class="main-header">
        <h2 id="pageTitle">Dashboard Executivo</h2>
        <div class="header-actions">
          <button class="btn" id="refreshButton" onclick="loadDashboard()">üîÑ Atualizar</button>
          <button class="btn btn-secondary" onclick="exportExcel()">üìä Exportar Excel</button>
          <button class="btn btn-secondary" onclick="exportCSV()">üìÑ Exportar CSV</button>
        </div>
      </header>

      <div id="messages"></div>
      
      <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Carregando dados...</p>
      </div>

      <!-- ====================== -->
      <!-- TAB: DASHBOARD         -->
      <!-- ====================== -->
      <div id="dashboard" class="tab-content active">
        <!-- KPIs Principais -->
        <div class="kpi-grid">
          <div class="stat-card">
            <h3>Total de Hosts</h3>
            <div class="value" id="totalHosts">-</div>
          </div>
          <div class="stat-card">
            <h3>Total de Vulnerabilidades</h3>
            <div class="value" id="totalVulns">-</div>
          </div>
          <div class="stat-card sev-critical">
            <h3>Cr√≠ticas</h3>
            <div class="value" id="criticalVulns">-</div>
          </div>
          <div class="stat-card sev-high">
            <h3>Altas</h3>
            <div class="value" id="highVulns">-</div>
          </div>
          <div class="stat-card sev-medium">
            <h3>M√©dias</h3>
            <div class="value" id="mediumVulns">-</div>
          </div>
        </div>

        <!-- Gr√°ficos Executivos -->
        <div class="charts-grid-col-2">
          <div class="chart-container">
            <h2>Distribui√ß√£o por Severidade</h2>
            <div class="chart-wrapper">
              <canvas id="severityChart"></canvas>
            </div>
          </div>
          
          <div class="chart-container">
            <h2>Tend√™ncia de Descobertas (Novas)</h2>
            <div class="chart-wrapper">
              <canvas id="trendsChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Gr√°ficos por Ambiente -->
        <h2 class="section-title">Vulnerabilidades por Ambiente (Cr√≠ticas, Altas, M√©dias)</h2>
        <div class="charts-grid-col-3">
          <div class="chart-container">
            <h2>üîß Desenvolvimento e Qualidade</h2>
            <canvas id="devQAChart"></canvas>
          </div>
          
          <div class="chart-container">
            <h2>‚ö†Ô∏è Produ√ß√£o Baixa</h2>
            <canvas id="prdBaixaChart"></canvas>
          </div>
          
          <div class="chart-container">
            <h2>üî¥ Produ√ß√£o Alta</h2>
            <canvas id="prdAltaChart"></canvas>
          </div>
        </div>
        
        <div class="chart-container">
          <h2>Top 10 Vulnerabilidades (QIDs)</h2>
          <div class="chart-wrapper-large">
            <canvas id="topVulnsChart"></canvas>
          </div>
        </div>
      </div>

      <!-- ====================== -->
      <!-- TAB: VULNERABILIDADES  -->
      <!-- ====================== -->
      <div id="vulnerabilities" class="tab-content">
        <div class="filter-section modern">
          <div class="filter-header">
            <div>
              <p class="eyebrow">Seguran√ßa</p>
              <h3>Filtros de Seguran√ßa</h3>
              <p class="filter-subtitle">Combine severidade, busca r√°pida e tags para refinar a lista.</p>
            </div>
            <div class="filter-actions">
              <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Limpar</button>
              <button class="btn" onclick="exportFiltered()">üì• Exportar CSV</button>
            </div>
          </div>

          <div class="filter-grid enhanced">
            <div class="filter-card severity-card">
              <div class="filter-card-title">Severidade</div>
              <div class="checkbox-group pill-group">
                <label class="pill critical"><input type="checkbox" class="severity-filter" value="5" checked onchange="applyFilters()"><span>Cr√≠tica</span></label>
                <label class="pill high"><input type="checkbox" class="severity-filter" value="4" checked onchange="applyFilters()"><span>Alta</span></label>
                <label class="pill medium"><input type="checkbox" class="severity-filter" value="3" checked onchange="applyFilters()"><span>M√©dia</span></label>
                <label class="pill low"><input type="checkbox" class="severity-filter" value="2" checked onchange="applyFilters()"><span>Baixa</span></label>
                <label class="pill info"><input type="checkbox" class="severity-filter" value="1" checked onchange="applyFilters()"><span>Info</span></label>
              </div>
            </div>

            <div class="filter-card">
              <div class="filter-card-title">Busca R√°pida</div>
              <p class="filter-hint">Busque por IP, DNS, t√≠tulo, QID, CVE ou solu√ß√£o.</p>
              <div class="input-with-icon">
                <span>üîé</span>
                <input type="text" id="quickSearch" placeholder="Digite para filtrar" oninput="applyFilters()">
              </div>
            </div>

            <div class="filter-card">
              <div class="filter-card-title">Tags do Host</div>
              <p class="filter-hint">Selecione uma tag cadastrada para filtrar os resultados.</p>
              <select id="tagFilter" onchange="applyFilters()">
                <option value="">Todas as Tags</option>
              </select>
            </div>

            <div class="filter-card">
              <div class="filter-card-title">Status e QID</div>
              <div class="dual-inputs">
                <div class="input-with-icon compact">
                  <span>üÜî</span>
                  <input type="text" id="filterQid" placeholder="Buscar por QID" oninput="applyFilters()">
                </div>
                <div class="input-with-icon compact">
                  <span>üìä</span>
                  <select id="filterStatus" onchange="applyFilters()">
                    <option value="">Todos os Status</option>
                    <option value="New">Novo</option>
                    <option value="Active">Ativo</option>
                    <option value="Re-Opened">Reaberto</option>
                    <option value="Fixed">Corrigido</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-container">
          <div class="table-header">
            <div>
              <p class="eyebrow">Lista</p>
              <h2>Vulnerabilidades (<span id="vulnCount">0</span> de <span id="vulnTotal">0</span>)</h2>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Detection ID</th>
                  <th>DNS</th>
                  <th>Host IP</th>
                  <th>Sistema Operacional</th>
                  <th>T√≠tulo</th>
                  <th>Solu√ß√£o</th>
                  <th>Resultados</th>
                  <th>Severidade</th>
                  <th>Status</th>
                  <th>QID</th>
                  <th>Porta</th>
                  <th>Primeira Detec√ß√£o</th>
                </tr>
              </thead>
              <tbody id="vulnTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ====================== -->
      <!-- TAB: EFETIVIDADE       -->
      <!-- ====================== -->
      <div id="efetividade" class="tab-content">
        <div class="section-header">
          <div>
            <p class="eyebrow">Nova An√°lise</p>
            <h2>Efetividade das Corre√ß√µes</h2>
            <p class="filter-subtitle">Processa o arquivo detection_ids.csv da raiz e consulta a API Qualys em tempo real.</p>
          </div>
          <div class="header-actions">
            <button class="btn" onclick="calculateEffectiveness()">üöÄ Calcular Efetividade</button>
          </div>
        </div>

        <div class="total-label" id="efetividadeTotalLabel" style="display: none;">
          Total de vulnerabilidades analisadas: <span id="efetividadeTotalInline">0</span>
        </div>

        <div class="kpi-grid" id="efetividadeKpis" style="display: none;">
          <div class="stat-card">
            <h3>Total Geral</h3>
            <div class="value" id="efetividadeTotal">-</div>
            <p class="small">Total de vulnerabilidades analisadas</p>
          </div>
          <div class="stat-card sev-high">
            <h3>DEV/QA</h3>
            <div class="value" id="efetividadeDevQa">-</div>
            <p class="small">Efetividade em DEV/QA</p>
          </div>
          <div class="stat-card sev-critical">
            <h3>Produ√ß√£o Alta</h3>
            <div class="value" id="efetividadePrdAlta">-</div>
            <p class="small">Efetividade em ambientes cr√≠ticos</p>
          </div>
          <div class="stat-card sev-medium">
            <h3>Produ√ß√£o Baixa</h3>
            <div class="value" id="efetividadePrdBaixa">-</div>
            <p class="small">Efetividade em ambientes de menor risco</p>
          </div>
        </div>

        <div class="charts-grid-col-3" id="efetividadeCharts" style="display: none;">
          <div class="chart-container">
            <h2>DEV_QA</h2>
            <canvas id="devQaEfetividadeChart"></canvas>
          </div>
          <div class="chart-container">
            <h2>PRD_Baixa</h2>
            <canvas id="prdBaixaEfetividadeChart"></canvas>
          </div>
          <div class="chart-container">
            <h2>PRD_Alta</h2>
            <canvas id="prdAltaEfetividadeChart"></canvas>
          </div>
        </div>

        <div class="chart-container" id="efetividadeTableWrapper" style="display: none;">
          <div class="table-header">
            <div>
              <p class="eyebrow">Detalhamento</p>
              <h2>Detection IDs processados</h2>
              <p class="filter-subtitle">Lista em mem√≥ria com status atual consultado na API do Qualys.</p>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Detection ID</th>
                  <th>Status</th>
                  <th>Severidade</th>
                  <th>QID</th>
                  <th>Host</th>
                  <th>√öltima Detec√ß√£o</th>
                  <th>Janela</th>
                </tr>
              </thead>
              <tbody id="efetividadeTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ====================== -->
      <!-- TAB: HOSTS             -->
      <!-- ====================== -->
      <div id="hosts" class="tab-content">
        <div class="filter-section">
          <h3>Busca de Servidores</h3>
          <div class="filter-group-single">
            <input type="text" id="searchHost" placeholder="üîç Buscar servidor (ex: SAP29, pratika, 10.62...)" onkeyup="filterHosts()">
            <button class="btn btn-secondary" onclick="clearHostSearch()">üóëÔ∏è Limpar Busca</button>
            <button class="btn" onclick="exportHosts()">üì• Exportar Hosts (CSV)</button>
          </div>
        </div>

        <div class="chart-container">
          <h2>Lista de Hosts (<span id="hostCount">0</span> de <span id="hostTotal">0</span>)</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>IP</th>
                  <th>DNS</th>
                  <th>NetBIOS</th>
                  <th>Tags</th>
                  <th>N¬∞ Vuln. (C/A/M)</th>
                  <th>OS</th>
                  <th>√öltimo Scan</th>
                </tr>
              </thead>
              <tbody id="hostTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ====================== -->
      <!-- TAB: SCANS             -->
      <!-- ====================== -->
      <div id="scans" class="tab-content">
        <div class="chart-container">
          <h2>Lista de Scans (<span id="scanCount">0</span>)</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Refer√™ncia</th>
                  <th>T√≠tulo</th>
                  <th>Tipo</th>
                  <th>Data de Execu√ß√£o</th>
                  <th>Estado</th>
                  <th>Alvo</th>
                </tr>
              </thead>
              <tbody id="scanTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ====================== -->
      <!-- TAB: API EXPLORER      -->
      <!-- ====================== -->
      <div id="api" class="tab-content">
        <div class="chart-container">
          <h2>API Explorer</h2>
          <div class="filter-group-single" style="margin-bottom: 20px;">
            <select id="apiEndpoint" style="flex-grow: 1;">
              <option value="/api/health">GET /api/health (Health Check)</option>
              <option value="/api/dashboard/summary">GET /api/dashboard/summary</option>
              <option value="/api/vulnerabilities">GET /api/vulnerabilities</option>
              <option value="/api/hosts">GET /api/hosts</option>
              <option value="/api/scans">GET /api/scans</option>
            </select>
            <button class="btn" onclick="testApiEndpoint()">üöÄ Executar</button>
          </div>
          <pre id="apiResponse" class="json-viewer">
            Selecione um endpoint e clique em Executar
          </pre>
        </div>
      </div>

    </main>
  </div>

  <script src="app.js"></script>
</body>
</html>
